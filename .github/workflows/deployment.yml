name: deployment
on: 
  push:
    branches: ["main"]
jobs:
  test-frontend-code:
    uses: ./.github/workflows/service_test.yml
    with:
      service: frontend
  test-backend-code:
    uses: ./.github/workflows/service_test.yml
    with:
      service: backend

  build-frontend:
    needs: test-frontend-code
    uses: ./.github/workflows/service_build.yml
    with:
      build_tag: ${{ github.sha }}
      service: frontend
    secrets:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
  build-backend:
    needs: test-backend-code
    uses: ./.github/workflows/service_build.yml
    with:
      build_tag: ${{ github.sha }}
      service: backend
    secrets:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

  update-configuration:
    needs: [build-frontend, build-backend]
    uses: ./.github/workflows/config_update_prod.yml
    secrets:
      SSH_SERVER_HOST: ${{ secrets.SSH_SERVER_HOST }}
      SSH_SERVER_PASSWORD: ${{ secrets.SSH_SERVER_PASSWORD }}
      SSH_SERVER_USERNAME: ${{ secrets.SSH_SERVER_USERNAME }}

  deployment-frontend:
    needs: [update-configuration]
    uses: ./.github/workflows/service_deployment.yml
    with:
      build_tag: ${{ github.sha }}
      namespace: prod
      service: frontend
    secrets:
      SSH_SERVER_HOST: ${{ secrets.SSH_SERVER_HOST }}
      SSH_SERVER_PASSWORD: ${{ secrets.SSH_SERVER_PASSWORD }}
      SSH_SERVER_USERNAME: ${{ secrets.SSH_SERVER_USERNAME }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  deployment-backend:
    needs: [update-configuration]
    uses: ./.github/workflows/service_deployment.yml
    with:
      build_tag: ${{ github.sha }}
      namespace: prod
      service: backend
    secrets:
      SSH_SERVER_HOST: ${{ secrets.SSH_SERVER_HOST }}
      SSH_SERVER_PASSWORD: ${{ secrets.SSH_SERVER_PASSWORD }}
      SSH_SERVER_USERNAME: ${{ secrets.SSH_SERVER_USERNAME }}
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
